# Stardeck Development Environment Setup

## Overview

Two-stage workflow: develop locally, test on Rocky Linux VM.

---

## Project Structure

```
stardeck/
├── backend/
│   ├── go.mod
│   ├── go.sum
│   ├── vendor/              # Vendored dependencies
│   ├── main.go
│   ├── frontend_dist/       # Embedded frontend (production build)
│   └── internal/
│       ├── api/
│       ├── auth/
│       ├── models/
│       └── system/
├── frontend/
│   ├── package.json
│   ├── next.config.js
│   ├── tailwind.config.js
│   ├── components/
│   ├── app/
│   └── out/                 # Static export output
├── scripts/
│   ├── install.sh           # Production install script
│   └── dev-setup.sh         # Dev environment setup
├── Makefile
├── README.md
└── CLAUDE.md                # Instructions for Claude Code
```

---

## Development Workstation

### Prerequisites

- Node.js 20+ (LTS)
- Go 1.22+
- Git
- Make
- Your preferred editor/IDE

### Initial Setup

```bash
# Clone repo
git clone <repo-url> stardeck
cd stardeck

# Frontend setup
cd frontend
npm install
cd ..

# Backend setup
cd backend
go mod tidy
go mod vendor
cd ..
```

### Running Development Mode

Two terminals, both processes running:

**Terminal 1 - Frontend (hot reload)**
```bash
cd frontend
npm run dev
# Runs on http://localhost:3000
```

**Terminal 2 - Backend**
```bash
cd backend
go run .
# Runs on http://localhost:8080
```

Access the app at `http://localhost:3000` - API calls proxy to Go backend.

---

## Next.js Configuration

```javascript
// frontend/next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'export',
  
  // Dev mode: proxy API to Go backend
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: 'http://localhost:8080/api/:path*',
      },
      {
        source: '/ws/:path*', 
        destination: 'http://localhost:8080/ws/:path*',
      },
    ]
  },
}

module.exports = nextConfig
```

---

## Test VM (Rocky Linux 10)

### VM Specs

| Resource | Minimum | Recommended |
|----------|---------|-------------|
| CPU | 1 vCPU | 2 vCPU |
| RAM | 1 GB | 2 GB |
| Disk | 10 GB | 20 GB |
| Network | NAT or Bridge | Bridge (for realistic testing) |

### VM Setup

```bash
# Minimal install Rocky Linux 10
# Post-install basics

# Enable SSH
sudo systemctl enable --now sshd

# Install prerequisites for testing
sudo dnf install -y podman

# Create stardeck user (mimics install script)
sudo useradd -r -s /sbin/nologin stardeck

# Create directories
sudo mkdir -p /opt/stardeck
sudo mkdir -p /var/lib/stardeck

# Firewall (open test port)
sudo firewall-cmd --add-port=8080/tcp --permanent
sudo firewall-cmd --reload
```

### Deploy for Testing

From dev workstation:

```bash
# Build and deploy
make build
make deploy VM=192.168.1.100 USER=youruser
```

On VM:

```bash
# Run binary directly for testing
sudo /opt/stardeck/stardeck

# Or install as service
sudo cp /tmp/stardeck.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl start stardeck
sudo systemctl status stardeck
```

---

## Makefile

```makefile
.PHONY: dev-frontend dev-backend build clean deploy test

# Development
dev-frontend:
	cd frontend && npm run dev

dev-backend:
	cd backend && go run .

# Build production binary
build: build-frontend build-backend

build-frontend:
	cd frontend && npm run build
	rm -rf backend/frontend_dist
	cp -r frontend/out backend/frontend_dist

build-backend:
	cd backend && go build -mod=vendor -o stardeck

# Clean build artifacts
clean:
	rm -rf frontend/out
	rm -rf frontend/.next
	rm -rf backend/frontend_dist
	rm -f backend/stardeck

# Deploy to test VM
# Usage: make deploy VM=192.168.1.100 USER=admin
deploy:
	scp backend/stardeck $(USER)@$(VM):/tmp/
	scp scripts/install.sh $(USER)@$(VM):/tmp/
	ssh $(USER)@$(VM) "sudo cp /tmp/stardeck /opt/stardeck/"

# Run tests
test:
	cd backend && go test -mod=vendor ./...

# Vendor dependencies
vendor:
	cd backend && go mod tidy && go mod vendor
```

---

## CLAUDE.md

Place this in the project root for Claude Code context:

```markdown
# Stardeck - Claude Code Instructions

## Project Overview
Stardeck is a web-based server management desktop for Rocky Linux.
Frontend: Next.js with static export
Backend: Go with Echo framework

## Go Dependencies
- Always use vendored dependencies
- After adding imports: `go mod tidy && go mod vendor`
- Build with: `go build -mod=vendor`
- Never use `-mod=mod` or download during build

## Frontend Build
- Development: `npm run dev` (runs on :3000, proxies to :8080)
- Production: `npm run build` (outputs to /out as static files)
- Static export only - no SSR, no API routes in Next.js

## Code Locations
- Backend API handlers: backend/internal/api/
- Backend system calls: backend/internal/system/
- Frontend components: frontend/components/
- Frontend pages: frontend/app/

## Commands
- `make dev-frontend` - Start Next.js dev server
- `make dev-backend` - Start Go backend
- `make build` - Build production binary
- `make deploy VM=<ip> USER=<user>` - Deploy to test VM

## Style
- Use Echo framework patterns for handlers
- Keep handlers thin, business logic in internal packages
- Frontend uses custom Starware shadcn theme
- Cassette futurism aesthetic - amber/cyan, angular, industrial
```

---

## Workflow Summary

| Stage | Location | Command | Result |
|-------|----------|---------|--------|
| Code | Workstation | `make dev-frontend` + `make dev-backend` | Hot reload development |
| Build | Workstation | `make build` | Single binary with embedded frontend |
| Deploy | Workstation → VM | `make deploy VM=x.x.x.x USER=admin` | Binary on test VM |
| Test | VM | `sudo /opt/stardeck/stardeck` | Production-like environment |
| Debug | VM | `journalctl -u stardeck -f` | Service logs |

---

## Git Workflow

```bash
# Branch naming
feature/desktop-shell
feature/auth-system
fix/session-timeout
refactor/api-structure

# Commit style
feat: add window manager component
fix: correct session expiration logic
docs: update environment setup
refactor: extract system calls to package
```

---

## Environment Variables

Development (optional, has defaults):

```bash
# backend/.env (not committed)
STARDECK_PORT=8080
STARDECK_DB_PATH=./stardeck.db
STARDECK_LOG_LEVEL=debug
STARDECK_TLS_ENABLED=false
```

Production:

```bash
# /etc/stardeck/stardeck.conf
STARDECK_PORT=443
STARDECK_DB_PATH=/var/lib/stardeck/stardeck.db
STARDECK_LOG_LEVEL=info
STARDECK_TLS_ENABLED=true
STARDECK_TLS_CERT=/opt/stardeck/certs/server.crt
STARDECK_TLS_KEY=/opt/stardeck/certs/server.key
```

---

## Homelab Integration

Since your KVM host is Rocky Linux 10:

```bash
# Create test VM from minimal cloud image
sudo virt-install \
  --name stardeck-test \
  --ram 2048 \
  --vcpus 2 \
  --disk size=20 \
  --os-variant rocky9 \
  --network bridge=br0 \
  --graphics none \
  --console pty,target_type=serial \
  --location /var/lib/libvirt/images/Rocky-10-GenericCloud.qcow2
```

Snapshot before testing install script:

```bash
sudo virsh snapshot-create-as stardeck-test clean-slate
```

Revert after testing:

```bash
sudo virsh snapshot-revert stardeck-test clean-slate
```

Fast iteration on install script without rebuilding VM.
